// lab5_starter.c
// Fur Elise, E155 Lab 5
// Updated Fall 2021

// Pitch in Hz, duration in ms

#include "../lib/FLASH.h"
#include "../lib/GPIO.h"
#include "../lib/RCC.h"
#include "../lib/TIM16.h"
#include "../lib/TIM67.h"

#define G5 784

#define E5 659

#define F5 698

#define D5 587

#define F4 349

const int bamba[][2] = {
    {G5, 1 * 200}, {F5, 1 * 200}, {E5, 2 * 200}, {D5, 2 * 200},
    {G5, 1 * 200}, {F5, 1 * 200}, {E5, 2 * 200}, {D5, 2 * 200},
    {G5, 1 * 200}, {F5, 1 * 200}, {E5, 2 * 200}, {G5, 1 * 200},
    {F5, 1 * 200}, {E5, 2 * 200}, {D5, 2 * 200}, {G5, 1 * 200},
    {F5, 1 * 200}, {E5, 2 * 200}, 
    {G5, 1 * 200}, {F5, 1 * 200}, {E5, 2 * 200}, {G5, 1 * 200},
    {F5, 1 * 200}, {E5, 2 * 200}, {D5, 2 * 200}, {G5, 1 * 200},
    {F5, 1 * 200}, {E5, 2 * 200}, {D5, 2 * 200}, {G5, 1 * 200},
    {F5, 1 * 200}, {E5, 2 * 200}, {F4, 4 * 200}
};

const int notes[][2] = {
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{416,	125},
{494,	125},
{523,	250},
{  0,	125},
{330,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{523,	125},
{494,	125},
{440,	250},
{  0,	125},
{494,	125},
{523,	125},
{587,	125},
{659,	375},
{392,	125},
{699,	125},
{659,	125},
{587,	375},
{349,	125},
{659,	125},
{587,	125},
{523,	375},
{330,	125},
{587,	125},
{523,	125},
{494,	250},
{  0,	125},
{330,	125},
{659,	125},
{  0,	250},
{659,	125},
{1319,	125},
{  0,	250},
{623,	125},
{659,	125},
{  0,	250},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{416,	125},
{494,	125},
{523,	250},
{  0,	125},
{330,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{523,	125},
{494,	125},
{440,	500},
{  0,	0}};

void delay(int ms) {
   while (ms-- > 0) {
      volatile int x=1000;
      while (x-- > 0)
         __asm("nop");
   }
}

int main(void) {

    
    // Set LED_PIN as output
    RCC->AHB2ENR |= (0b1 << 0); // enable GPIOA
    RCC->APB2ENR |= (0b1 << 17); // enable tim16
    RCC->CFGR |= (0b1001 << 4); // set APB2PRESC to 4
    RCC->APB1ENR1 |= (0b1 << 4); // enable tim6
    RCC->APB2ENR |= (0b1 << 17); // enable tim16

    setUpTIM6();
    setUpPWM(0, 50);
   
    pinMode(6, GPIO_ALT);
    GPIO->AFRL |= (0b1110 << 24);

    int numNotes = sizeof(notes)/sizeof(notes[0]);
    int bambaNotes = sizeof(bamba)/sizeof(bamba[0]); // Calculate number of notes

    // for (int i = 0; i < numNotes-1; i++) {
    //     int pitch = notes[i][0];  // Get the pitch
    //     int delay = notes[i][1];  // Get the delay
    //     changeFreq(pitch, 50);
    //     delayTIM6(delay);
    // }

    for (int j = 0; j < bambaNotes; j++) {
        int pitch = bamba[j][0];  // Get the pitch
        int delay = bamba[j][1];  // Get the delay
        changeFreq(pitch, 50);
        delayTIM6(delay);
    }
    while(1) {
      
    }
    return 0;
	
}